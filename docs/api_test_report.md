# 河流漂浮物检测系统 API 批量测试问题记录

## 测试环境
- FastAPI 后端已启动，端口 8000
- 使用脚本 backend/scripts/test_all_endpoints.py 进行批量接口测试

## 主要问题与现象

### 1. 用户相关接口
- 用户注册、登录、查询、修改、删除接口均能正常返回。
- 测试过程中 user_id=1 被删除，导致后续依赖该用户的接口（如视频上传、日志添加）失败。

### 2. 视频相关接口
- 视频上传接口 `/api/videos/upload` 返回：
  ```json
  {"detail": "用户不存在"}
  ```
  原因：user_id=1 已被删除。
- 视频查询、删除接口可正常返回。

### 3. 检测相关接口
- `/api/detect/image` 返回 500 错误（Internal Server Error）。
  - 可能原因：mock 图片内容不符合模型输入要求，或模型推理异常。
- `/api/detect/video` 返回参数缺失：
  ```json
  {"detail": [{"type": "missing", "loc": ["query", "video_id"], "msg": "Field required", "input": None}]}
  ```
  - 可能原因：应以 query 参数或 form-data 方式传递 video_id。

### 4. 检测结果与日志接口
- 检测结果查询接口可正常返回。
- 日志添加接口 `/api/logs` 返回 500 错误。
  - 可能原因：user_id=1 已被删除，导致外键约束失败。

## 建议与改进
1. **测试数据准备**：
   - 测试前应确保存在有效的测试用户、视频等数据。
   - 可在脚本中自动创建并复用测试用户，避免因用户被删除导致后续接口失败。
2. **mock 文件内容**：
   - 检测类接口建议使用真实图片/视频文件，或生成更符合格式的 mock 数据。
3. **接口参数传递**：
   - 检查 `/api/detect/video` 的参数传递方式，确保与后端接口定义一致。
4. **错误处理与日志**：
   - 增强接口的异常处理，返回更详细的错误信息，便于定位问题。
5. **测试顺序优化**：
   - 避免先删除用户再测试依赖该用户的接口。

## 后续计划
- 优化测试脚本，自动化数据准备与清理。
- 针对检测类接口补充真实文件测试。
- 开始前端页面编写与接口联调。 